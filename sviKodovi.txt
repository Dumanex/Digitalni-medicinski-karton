#include <iostream>

#include "osoba.h"
#include "medicinskaIstorija.h"
#include "pacijent.h"
#include "doktor.h"
#include "sistemZdravstva.h"
#include "lek.h"

using namespace std;


int main(int argc, char const *argv[])
{
    sistemZdravstva sistem;

    Pacijent *p1 = new Pacijent("Vladimir", "Dumanovic", M, {20, "Novembar", 2003}, "Vojislava Tankosica 10/5", "0604567063");
    p1 -> getMedicinskaIstorija().dodajBolest("Grip");
    p1 -> getMedicinskaIstorija().dodajBolest("Upala");
    sistem.dodajPacijenta(p1);
    sistem.dodajOsobu(p1);
    /* Pacijent p2("Fakundo", "Campazzo", M, {10, "Avgust", 1999}, "Miška Ražnatovića 2/498", "062389218");
    p2.getMedicinskaIstorija().dodajBolest("Grip");
    sistem.dodajPacijenta(p2); */

    Doktor *obicanDoktor = new Doktor("Milovan", "Glisic", M, {23, "Jun", 2003}, "Nikole Pasica 5/2", "0601234567");
    sistem.dodajDoktora(obicanDoktor);
    sistem.dodajOsobu(obicanDoktor);
    /* Doktor plucniDoktor("Ljiljana", "Todorovic", Z, {1, "Januar", 2004}, "Kralja Aleksandra 15/32", "069762345", "Plucne bolesti");
    sistem.dodajDoktora(plucniDoktor); */

    Lek *aspirin = new Lek("Aspirin",{"Grip", "Glavobolja"});
    sistem.dodajLek(aspirin);
    /* Lek penicilin("Penicilin",{"Infekcija", "Upala"});
    sistem.dodajLek(penicilin); */


    int opcija = 0;

    while (opcija != 6) {
        cout << "\n---------------------------------\n";
        cout << "\n   DIGITALNI MEDICINSKI KARTON   \n";
        cout << "\n---------------------------------\n";
        cout << "1. Dodaj pacijenta\n";
        cout << "2. Dodaj doktora\n";
        cout << "3. Dodaj lek\n";
        cout << "4. Zakazi termin za sve pacijente\n";
        cout << "5. Prikazi informacije o sistemu zdravstva\n";
        cout << "6. Izlaz\n";
        cout << "------------------------------\n";
        cout << "Izaberite opciju: ";
        cin >> opcija;
        cin.ignore();

        switch(opcija) {
            case 1: {
                Pacijent *pomPacijent = Pacijent::kreirajPacijenta();
                sistem.dodajPacijenta(pomPacijent);
                sistem.dodajOsobu(pomPacijent);
                break;
            }
            case 2: {
                Doktor *pomDoktor = Doktor::kreirajDoktora();
                sistem.dodajDoktora(pomDoktor);
                sistem.dodajOsobu(pomDoktor);
                break;
            }
            case 3: {
                Lek *pomLek = Lek::kreirajLek();
                sistem.dodajLek(pomLek);
                break;
            }
            case 4: {
                if (sistem.getPacijenti().empty() || sistem.getDoktori().empty()) {
                    cout << "Nema pacijenata ili doktora u sistemu za zakazivanje termina.\n";
                    break;
                }

                sistem.zakaziTerminZaSvePacijente();
                break;
            }
            case 5:
                sistem.prikaziInformacije();
                break;
            case 6:
                cout << "\nIzlaz iz programa.\n" << endl;
                break;
            default:
                cout << "Nepoznata opcija. Pokusajte ponovo.\n";
                break;
        }
    }

    return 0;
}

#ifndef OSOBA_H
#define OSOBA_H

#include <iostream>
using namespace std;

#include "datum.h"

enum polOsobe {M, Z, NEPOZNATO};

class Osoba {
    string _ime;
    string _prezime;
    polOsobe _pol;
    Datum _datumRodjenja;
    string _adresa;
    string _brTelefona;
public:
    Osoba(string ime, string prezime, polOsobe pol, Datum datumRodjenja, string adresa, string brTelefona);
    virtual ~Osoba();

    virtual void prikaziPodatke() const = 0;

    string getIme() const;
    string getPrezime() const;
    polOsobe getPol() const;
    string prikaziPol() const;
    Datum getDatumRodjenja() const;
    string getAdresa() const;
    string getBrTelefona() const;
};

#endif
#include "osoba.h"

Osoba::Osoba(string ime, string prezime, polOsobe pol, Datum datumRodjenja, string adresa, string brTelefona ) : _ime(ime), _prezime(prezime), _pol(pol), _datumRodjenja(datumRodjenja), _adresa(adresa), _brTelefona(brTelefona) {
}

Osoba::~Osoba() {
    cout << "Destruktor za osobu." << endl;
}

string Osoba::getIme() const {
    return _ime;
}

string Osoba::getPrezime() const {
    return _prezime;
}

polOsobe Osoba::getPol() const {
    return _pol;
}

string Osoba::prikaziPol() const {
    if(_pol == polOsobe::M) {
        return "Muski";
    } else if(_pol == polOsobe::Z){
        return "Zenski";
    } else {
        return "Nepoznat";
    }
}

Datum Osoba::getDatumRodjenja() const {
    return _datumRodjenja;
}

string Osoba::getAdresa() const {
    return _adresa;
}

string Osoba::getBrTelefona() const {
    return _brTelefona;
}

#ifndef PACIJENT_H
#define PACIJENT_H

using namespace std;

#include "osoba.h"
#include "medicinskaIstorija.h"
#include "doktor.h"
#include "lek.h"

class Doktor;

class Pacijent : public Osoba {
    vector<Lek*> lekovi;
    medicinskaIstorija istorija;
public:

    Pacijent(string ime, string prezime, polOsobe pol, Datum datumRodjenja, string adresa, string brTelefona);
    ~Pacijent();

    void prikaziPodatke() const override;
    void zakaziTermin(Doktor *doktor);
    void dodajLek(Lek *lek);
    vector<Lek*> getLek();
    medicinskaIstorija& getMedicinskaIstorija(); // stavili smo medicinskaIstorija& i ovaj ampersent je bitan zato sto ce da vrati referencu na objekat i tako u main mozemo da menjamo njegove podatke
    static Pacijent* kreirajPacijenta(); // koristimo static metodu kako ne bismo morali da pravimo objekat tipa Pacijent
};

#endif
#include "pacijent.h"

#include "lekException.h"
#include "terminException.h"

using namespace std;

Pacijent::Pacijent(string ime, string prezime, polOsobe pol, Datum datumRodjenja ,string adresa, string brTelefona) : Osoba(ime, prezime, pol, datumRodjenja, adresa, brTelefona) {}

Pacijent::~Pacijent() {
    cout << "Destruktor za pacijenta." << endl;

    for(auto *lek : lekovi) {
        delete lek;
    }
}

void Pacijent::prikaziPodatke() const {
    cout << "---------------------------------\n";
    cout << "        PODACI O PACIJENTU       \n";
    cout << "---------------------------------\n";
    cout << "Ime:           " << getIme() << "\n"
         << "Prezime:       " << getPrezime() << "\n"
         << "Pol:           " << prikaziPol() << "\n" 
         << "Datum rođenja: " << getDatumRodjenja()._dan << ". " << getDatumRodjenja()._mesec << " " << getDatumRodjenja()._godina << "." << "\n"
         << "Adresa:        " << getAdresa() << "\n" 
         << "Broj telefona: " << getBrTelefona() << "\n";
    cout << endl;

    istorija.ispisiIstoriju();
    cout << "Lekovi: ";
    for(auto lek : lekovi)
    {
       cout << lek->getNaziv() << " | "; 
    }
    cout << "\n---------------------------------\n";
    cout << endl;
}

void Pacijent::zakaziTermin(Doktor *doktor) {

    cout << "Izabrali ste doktora: " << doktor -> getIme() << " " << doktor -> getPrezime() << " (" << doktor -> getSpecijalnost() << ")" << endl;
    doktor -> prikaziDostupneTermine();

    cout << "Izaberite termin(sati): ";
    int termin;
    cin >> termin;

    if(doktor -> zakaziTermin(termin)) {
        cout << "Termin uspesno zakazan za " << termin << ":00" << endl;
    }
    else {
        throw terminException();
    }
    cout << "---------------------------------\n";
}

void Pacijent::dodajLek( Lek *lek) {
    for(const auto &trenutniLek : lekovi) {
        if(trenutniLek -> getNaziv() == lek -> getNaziv()) {
            return;
        }
    }

    bool lekJeDodat = false;

    for(string bolestPacijenta : istorija.getBolesti()) {
        if(lek -> daLiJeOdgovarajucaBolest(bolestPacijenta)) {
            lekovi.push_back(lek);
            cout << "Lek " << lek -> getNaziv() << " je uspesno dodat pacijentu " << getIme() << " " << getPrezime() << endl;
            lekJeDodat = true;
            break;
        }
        if(lekJeDodat) {
            break;
        }
    }

    if(!lekJeDodat) {
        throw lekException(getIme(), lek -> getNaziv());
    }
}

vector<Lek*> Pacijent::getLek() {
    return lekovi;
}

medicinskaIstorija& Pacijent::getMedicinskaIstorija() {
    return istorija;
}

Pacijent* Pacijent::kreirajPacijenta() {
    string ime, prezime, adresa, brTelefona, bolest;
    polOsobe pol;
    char slovoPola;

    int dan;
    string mesec;
    int godina;

    int brBolesti;

    cout << endl;
    cout << "Unesite ime pacijenta: ";
    getline(cin, ime); // getline se koristi kako bi se pokupio ceo red, dok cin kupi to prve praznine

    cout << "Unesite prezime pacijenta: ";
    getline(cin, prezime);

    cout << "Unesite pol pacijenta (M/Z): ";
    cin >> slovoPola;
    cin.ignore(); // kada bi koristili getline nakon cin >> variabla, ostao bi \n u baferu. Ovim ignore zapravo ignorisemo taj prvi karakter koji je ostao u baferu
    if(slovoPola == 'M' || slovoPola == 'm') {
        pol = polOsobe::M;
    } else if(slovoPola == 'Z' || slovoPola == 'z') {
        pol = polOsobe::Z;
    } else {
        pol = polOsobe::NEPOZNATO;
    }

    cout << "Unesite dan rodjenja pacijenta (dd): ";
    cin >> dan;
    cin.ignore();

    cout << "Unesite mesec rodjenja pacijenta (MESEC): ";
    getline(cin, mesec);

    cout << "Unesite godina rodjenja pacijenta (yyyy): ";
    cin >> godina;
    cin.ignore();

    cout << "Unesite adresu pacijenta: ";
    getline(cin, adresa);

    cout << "Unesite broj telefona pacijenta: ";
    getline(cin, brTelefona);

    Pacijent *noviPacijent = new Pacijent(ime, prezime, pol, {dan, mesec, godina}, adresa, brTelefona);

    cout << "Koliko bolesti ima pacijent? ";
    cin >> brBolesti;
    cin.ignore();

    for(int i = 0; i < brBolesti; i++) {
        cout << "Unesite " << i + 1 << "." << " bolest: ";
        getline(cin, bolest);
        noviPacijent->getMedicinskaIstorija().dodajBolest(bolest);
    }

    return noviPacijent;
}

#ifndef MEDICINSKAISTORIJA_H
#define MEDICINSKAISTORIJA_H

#include <iostream>
#include <vector>
#include <string>

using namespace std;

class medicinskaIstorija {
    vector<string> bolesti;
public:

    void dodajBolest(string bolest);
    vector<string> getBolesti();
    void ispisiIstoriju() const;
};

#endif
#include "medicinskaIstorija.h"

void medicinskaIstorija::dodajBolest(string bolest) {
    for(string postojecaBolest : bolesti) {
        if(postojecaBolest == bolest) {
            return;
        }
    }
    bolesti.push_back(bolest);
}

vector<string> medicinskaIstorija::getBolesti() {
    return bolesti;
}

void medicinskaIstorija::ispisiIstoriju() const{
    cout << "Bolesti: ";
    for(auto bolest : bolesti)
    {
       cout << bolest << " | "; 
    }
    
    cout << endl;
}

#ifndef LEK_H
#define LEK_H

using namespace std;

#include <string>
#include <vector>
#include "medicinskaIstorija.h"

class Lek {
private:
    string _naziv;
    vector<string> _odgovarajuceBolesti;
public:
    Lek(string naziv, vector<string> odgovarajuceBolesti);

    string getNaziv() const;
    vector<string> getOdgocarajuceBolesti() const;
    bool daLiJeOdgovarajucaBolest(string bolest) const;
    static Lek* kreirajLek();
};

#endif
#include "lek.h"

Lek::Lek(string naziv, vector<string> odgovarajuceBolesti) : _naziv(naziv), _odgovarajuceBolesti(odgovarajuceBolesti) {}

string Lek::getNaziv() const {
    return _naziv;
}

vector<string> Lek::getOdgocarajuceBolesti() const {
    return _odgovarajuceBolesti;
}

bool Lek::daLiJeOdgovarajucaBolest(string bolest) const {
    for(string bolestLeka : _odgovarajuceBolesti) {
        if(bolest == bolestLeka) {
            return true;
        }
    }
    return false;
}

Lek* Lek::kreirajLek() {
    string naziv;
    int brojBolesti;
    vector<string> bolesti;

    cout << "Unesite naziv leka: ";
    getline(cin, naziv);

    cout << "Koliko bolesti leči ovaj lek? ";
    cin >> brojBolesti;
    cin.ignore();

    for (int i = 0; i < brojBolesti; i++) {
        string bolest;
        cout << "Unesite naziv bolesti: ";
        getline(cin, bolest);
        bolesti.push_back(bolest);
    }

    Lek *noviLek = new Lek(naziv, bolesti);
    
    return noviLek;
}

#ifndef DOKTOR_H
#define DOKTOR_H

#include "osoba.h"
#include "pacijent.h"
#include "lek.h"
#include <vector>
#include <map>

class Pacijent;
class Lek;

class Doktor : public Osoba {
    string _specijalnost;
    map<int, bool> termini; // map koristimo da bi za odredjeno vreme videli da li ima slobodan termin(int su satnice, npr. 8, a bool je true ili false u zavisnosti da li je ta satnica slobodna ili ne, ako je true onda je slobodna)
public:
    Doktor(string ime, string prezime, polOsobe pol, Datum datumRodjenja, string adresa, string brTelefona, string specijalnost = "Opsta praksa");
    ~Doktor();

    string getSpecijalnost() const;
    void prikaziPodatke() const override;

    void prikaziDostupneTermine() const;
    bool zakaziTermin(int termin);
    void predloziLek(Pacijent *pacijent, Lek *lek);
    static Doktor* kreirajDoktora();
};

#endif
#include "doktor.h"

#include "lekException.h"

Doktor::Doktor(string ime, string prezime, polOsobe pol, Datum datumRodjenja, string adresa, string brTelefona, string specijalnost) : Osoba(ime, prezime, pol, datumRodjenja, adresa, brTelefona), _specijalnost(specijalnost) {
    //inicijalizacija termina od 08:00 do 13:00h
    for(int i = 8; i < 13; i++) {
        termini[i] = true; // svi termini su slobodni na pocetku
    }
}

Doktor::~Doktor() {
    cout << "Destruktor za doktora." << endl;
}

string Doktor::getSpecijalnost() const{
    return _specijalnost;
}

void Doktor::prikaziPodatke() const {
    cout << "\n---------------------------------\n";
    cout << "        PODACI O DOKTORU        \n";
    cout << "---------------------------------\n";
    cout << "Ime:           " << getIme() << "\n"
         << "Prezime:       " << getPrezime() << "\n"
         << "Pol:           " << prikaziPol() << "\n" 
         << "Datum rođenja: " << getDatumRodjenja()._dan << ". " << getDatumRodjenja()._mesec << " " << getDatumRodjenja()._godina << "." << "\n"
         << "Adresa:        " << getAdresa() << "\n" 
         << "Broj telefona: " << getBrTelefona() << "\n"
         << "Specijalnost:  " << getSpecijalnost() << "\n";
    cout << "---------------------------------\n";
}

void Doktor::prikaziDostupneTermine() const {
   cout << "\n---------------------------------\n";
    cout << "   DOSTUPNI TERMINI ZA DOKTORA   \n";
    cout << "---------------------------------\n";
    for (const auto& termin : termini) {
        cout << "Termin: " << termin.first << ":00 - " 
             << (termin.second ? "Dostupno" : "Zauzeto") << "\n";
    }
    cout << "---------------------------------\n";
}

bool Doktor::zakaziTermin(int termin) {
    if(termini.find(termin) != termini.end() && termini[termin]) {
        termini[termin] = false;
        return true;
    }
    return false;
}

void Doktor::predloziLek(Pacijent *pacijent, Lek *lek) {
    try {
        pacijent -> dodajLek(lek);
    } catch (lekException e) {
        cout << e.what() << endl;
    }
}

Doktor* Doktor::kreirajDoktora() {
    string ime, prezime, adresa, brTelefona, bolest, specijalnost;
    polOsobe pol;
    char slovoPola;

    int dan;
    string mesec;
    int godina;

    int brBolesti;

    cout << endl;
    cout << "Unesite ime doktora: ";
    getline(cin, ime); // getline se koristi kako bi se pokupio ceo red, dok cin kupi to prve praznine

    cout << "Unesite prezime doktora: ";
    getline(cin, prezime);

    cout << "Unesite pol doktora (M/Z): ";
    cin >> slovoPola;
    cin.ignore(); // kada bi koristili getline nakon cin >> variabla, ostao bi \n u baferu. Ovim ignore zapravo ignorisemo taj prvi karakter koji je ostao u baferu
    if(slovoPola == 'M' || slovoPola == 'm') {
        pol = polOsobe::M;
    } else if(slovoPola == 'Z' || slovoPola == 'z') {
        pol = polOsobe::Z;
    } else {
        pol = polOsobe::NEPOZNATO;
    }

    cout << "Unesite dan rodjenja doktora (dd): ";
    cin >> dan;
    cin.ignore();

    cout << "Unesite mesec rodjenja doktora (MESEC): ";
    getline(cin, mesec);

    cout << "Unesite godina rodjenja doktora (yyyy): ";
    cin >> godina;
    cin.ignore();

    cout << "Unesite adresu doktora: ";
    getline(cin, adresa);

    cout << "Unesite broj telefona doktora: ";
    getline(cin, brTelefona);

    cout << "Unesite specijalnost doktora: ";
    getline(cin, specijalnost);
    if(specijalnost == "") {
        specijalnost = "Opsta praksa";
    }

    Doktor *noviDoktor = new Doktor(ime, prezime, pol, {dan, mesec, godina}, adresa, brTelefona, specijalnost);

    return noviDoktor;
}

#ifndef SISTEMZDRAVSTVA_H
#define SISTEMZDRAVSTVA_H

#include <vector>
#include "doktor.h"
#include "pacijent.h"
#include "lek.h"

class sistemZdravstva {
    //vector<Osoba*> osobe;
    vector<Pacijent*> pacijenti;
    vector<Doktor*> doktori;
    vector<Lek*> lekovi;
public:
    ~sistemZdravstva();

    //void dodajOsobu(Osoba *osoba);
    void dodajPacijenta(Pacijent *pacijent);
    void dodajDoktora(Doktor *doktor);
    void dodajLek(Lek *lek);

    vector<Pacijent*> getPacijenti() const;
    vector<Doktor*> getDoktori() const;
    vector<Lek*> getLekovi() const;

    void prikaziSveDoktore() const;
    void zakaziTerminZaSvePacijente();
    void prikaziInformacije();
};

#endif
#include "sistemZdravstva.h"

#include "terminException.h"
#include "doktorException.h"

#include "lekException.h"

sistemZdravstva::~sistemZdravstva() {
    cout << "Destruktor za sistem zdravstva." << endl;
    for(auto &osoba : osobe) {
        delete osoba;
    }

    for(auto &pacijent : pacijenti) {
        delete pacijent;
    }

    for(auto &doktor : doktori) {
        delete doktor;
    }

    for(auto &lek : lekovi) {
        delete lek;
    }
}

void sistemZdravstva::dodajOsobu(Osoba *osoba) {
    osobe.push_back(osoba);
}

void sistemZdravstva::dodajDoktora(Doktor *doktor) {
    doktori.push_back(doktor);
}

void sistemZdravstva::dodajPacijenta(Pacijent *pacijent) {
    pacijenti.push_back(pacijent);
}

void sistemZdravstva::dodajLek(Lek *lek) {
    lekovi.push_back(lek);
}

vector<Pacijent*> sistemZdravstva::getPacijenti() const {
    return pacijenti;
}

vector<Doktor*> sistemZdravstva::getDoktori() const {
    return doktori;
}

vector<Lek*> sistemZdravstva::getLekovi() const {
    return lekovi;
}

void sistemZdravstva::prikaziSveDoktore() const {
    for (size_t i = 0; i < doktori.size(); ++i) {
        cout << i + 1 << ". " << doktori[i] -> getIme() << " " << doktori[i] -> getPrezime()
             << " - Specijalnost: " << doktori[i] -> getSpecijalnost() << "\n";
    }
}

void sistemZdravstva::zakaziTerminZaSvePacijente() {
    for (auto& pacijent : pacijenti) {
        bool zakazano = false;

        while (!zakazano) {
            cout << "\n---------------------------------\n";
            cout << "   ZAKAZIVANJE TERMINA ZA PACIJENTA   \n";
            cout << "---------------------------------\n";
            cout << "Pacijent: " << pacijent -> getIme() << " " << pacijent -> getPrezime() << "\n";
            cout << "Izaberite doktora:\n";
            prikaziSveDoktore();

            int izborDoktora;
            cin >> izborDoktora;

            try {
                if (izborDoktora <= 0 || izborDoktora > static_cast<int>(doktori.size())) {
                    throw doktorException();
                }
                
                Doktor *izabraniDoktor = doktori[izborDoktora - 1];
                pacijent -> zakaziTermin(izabraniDoktor);
                zakazano = true;

                for (auto &lek : lekovi) {
                    try {
                        izabraniDoktor -> predloziLek(pacijent, lek);
                    } catch (const lekException& e) {
                        cout << e.what() << endl;
                    }
                }
            } catch (const terminException& e) {
                cout << e.what() << endl;
                cout << "Pokušajte ponovo.\n";
            } catch (const doktorException& e) {
                cout << e.what() << endl;
                cout << "Pokušajte ponovo.\n";
            } catch (...) {
                cout << "Generalna greška...\n";
                zakazano = true;
            }
        }
        cout << "---------------------------------\n";
    }
}



void sistemZdravstva::prikaziInformacije() {
    int brPacijenata = 0;
    int brDoktora = 0;
    int brLekova = 0;
    brPacijenata = pacijenti.size();
    brDoktora = doktori.size();
    brLekova = lekovi.size();

    cout << "\n---------------------------------------------------\n";
    cout << "    PRIKAZIVANJE INFORMACIJA O ZDRAVSTVENOM SISTEMU    ";
    cout << "\n---------------------------------------------------\n";
    cout << "Broj pacijenata: " << brPacijenata << endl;
    cout << "Broj doktora: " << brDoktora << endl;
    cout << "Broj lekova: " << brLekova << endl;
    cout << "   Informacije o osobama u sistemu   " << endl;
    for(auto &osoba : osobe) {
        osoba -> prikaziPodatke();
    }
}